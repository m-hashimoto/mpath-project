--- ip6_output.c.org	2011-01-27 02:32:49 +0900
+++ ip6_output.c	2011-01-27 11:46:06 +0900
@@ -215,6 +215,7 @@
 	int segleft_org = 0;
 	struct secpolicy *sp = NULL;
 #endif /* IPSEC */
+	dprint(("ip6_output Start\n"));
 
 	ip6 = mtod(m, struct ip6_hdr *);
 	if (ip6 == NULL) {
@@ -589,6 +590,19 @@
 		 */
 		*dst = dst_sa;	/* XXX */
 	}
+	/*
+	 * select nexthops by ip6_flow
+	 */
+	dprint(("ip6_output: mara forwarding!\n"));
+	uint32_t mara_tag = ip6->ip6_flow;
+	dprint(("ip6_output: ip6_flow[%d]",mara_tag));
+	if(mara_tag != 0){
+		mara_tag = arc4random();
+		ip6->ip6_flow = mara_tag;
+	}
+	dprint((" mara_tag[%d]\n",mara_tag));
+	if(rt != NULL)
+		rt = multipath_nexthop((unsigned int)mara_tag,rt);
 
 	/*
 	 * then rt (for unicast) and ifp must be non-NULL valid values.
