--- ip6_output.c.org	2011-01-27 02:32:49 +0900
+++ ip6_output.c	2011-01-27 10:08:12 +0900
@@ -589,6 +589,16 @@
 		 */
 		*dst = dst_sa;	/* XXX */
 	}
+	/*
+	 * select nexthops by ip6_flow
+	 */
+	uint32_t mara_tag = ip6->ip6_flow;
+	if(mara_tag != 0){
+		mara_tag = arc4random();
+		ip6->ip6_flow = mara_tag;
+	}
+	if(rt != NULL)
+		rt = malutipath_nexthop((unsigned int)mara_tag,rt);
 
 	/*
 	 * then rt (for unicast) and ifp must be non-NULL valid values.
