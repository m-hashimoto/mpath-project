--- ip_output.c.org	2005-02-24 17:01:11.000000000 +0900
+++ ip_output.c	2011-01-21 09:53:25.000000000 +0900
@@ -135,6 +135,7 @@
 #ifdef IPSEC
 	int no_route_but_check_spd = 0;
 #endif
+	int mara_tag;
 	M_ASSERTPKTHDR(m);
 
 	if (inp != NULL) {
@@ -169,7 +170,13 @@
 			hlen = len;
 	}
 	ip = mtod(m, struct ip *);
-
+#ifdef PTREE_MPATH
+	/* forwarding for MARA */
+	mara_tag = ip->ip_tos;
+	if (mara_tag){
+		ro->ro_rt = multipath_nexthop(mara_tag,ro->ro_rt);
+	}
+#endif
 	/*
 	 * Fill in IP header.  If we are not allowing fragmentation,
 	 * then the ip_id field is meaningless, but we don't set it
@@ -309,9 +316,8 @@
 		if (ro->ro_rt->rt_rmx.rmx_mtu > ifp->if_mtu)
 			ro->ro_rt->rt_rmx.rmx_mtu = ifp->if_mtu;
 		mtu = ro->ro_rt->rt_rmx.rmx_mtu;
-	} else {
+	} else 
 		mtu = ifp->if_mtu;
-	}
 	if (IN_MULTICAST(ntohl(ip->ip_dst.s_addr))) {
 		m->m_flags |= M_MCAST;
 		/*
@@ -661,6 +667,7 @@
 		IPSTAT_INC(ips_fragmented);
 
 done:
+	dprint(("ip_output: done\n"));
 	if (ro == &iproute && ro->ro_rt && !nortfree) {
 		RTFREE(ro->ro_rt);
 	}
@@ -668,6 +675,7 @@
 		ifa_free(&ia->ia_ifa);
 	return (error);
 bad:
+	dprint(("ip_output: bad\n"));
 	m_freem(m);
 	goto done;
 }
